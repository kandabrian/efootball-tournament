<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Vumbua eFootball</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' /wallet/balance /tournaments /tournament/join /friends/create-match /friends/join-match /friends/cancel-match /friends/my-matches /friends/submit-result /wallet/deposit /wallet/deposit/status /wallet/withdraw;">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon: #00ff41;
            --neon-dim: rgba(0,255,65,0.08);
            --bg: #060608;
            --surface: #0c0c0f;
            --card: #111116;
            --card2: #161619;
            --border: rgba(255,255,255,0.06);
            --text: #f0f0f0;
            --muted: #666;
            --danger: #ff4444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; min-height: 100vh; overflow-x: hidden; }
        #loading-screen {
            position: fixed; inset: 0; z-index: 1000; background: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px;
        }
        .spinner {
            width: 36px; height: 36px; border: 2px solid rgba(0,255,65,0.15);
            border-top-color: var(--neon); border-radius: 50%; animation: spin 0.7s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 0.75rem; letter-spacing: 3px; color: var(--muted); text-transform: uppercase; }
        .pitch-bg {
            position: fixed; inset: 0; z-index: 0;
            background: radial-gradient(ellipse 60% 40% at 70% 0%, rgba(0,255,65,0.04) 0%, transparent 55%);
        }
        .pitch-lines {
            position: fixed; inset: 0; z-index: 0; opacity: 0.025;
            background-image:
                repeating-linear-gradient(0deg, transparent, transparent 79px, rgba(0,255,65,0.8) 80px),
                repeating-linear-gradient(90deg, transparent, transparent 79px, rgba(0,255,65,0.8) 80px);
            animation: gridDrift 25s linear infinite;
        }
        @keyframes gridDrift { 0% { transform: translateY(0); } 100% { transform: translateY(80px); } }
        .app {
            position: relative; z-index: 1; max-width: 480px; margin: 0 auto;
            padding: 0 0 80px 0; min-height: 100vh;
            animation: fadeIn 0.5s ease both;
        }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        .topnav {
            display: flex; align-items: center; justify-content: space-between;
            padding: 20px 20px 16px;
            position: sticky; top: 0; z-index: 10;
            background: linear-gradient(to bottom, var(--bg) 70%, transparent);
        }
        .nav-logo { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 4px; color: var(--neon); }
        .nav-right { display: flex; align-items: center; gap: 10px; }
        .nav-user {
            display: flex; align-items: center; gap: 8px;
            background: var(--card); border: 1px solid var(--border);
            padding: 7px 14px; border-radius: 20px;
        }
        .avatar {
            width: 26px; height: 26px; border-radius: 50%;
            background: var(--neon); color: #000; display: flex; align-items: center;
            justify-content: center; font-size: 0.7rem; font-weight: 800;
        }
        .nav-username { font-size: 0.82rem; color: var(--neon); font-weight: 600; }
        .btn-logout {
            background: none; border: 1px solid var(--border); color: var(--muted);
            padding: 7px 12px; border-radius: 20px; cursor: pointer; font-size: 0.75rem;
            font-family: 'Outfit', sans-serif; transition: border-color 0.2s, color 0.2s;
        }
        .btn-logout:hover { border-color: rgba(255,68,68,0.4); color: #ff8888; }
        .content { padding: 0 16px; }
        .wallet-card {
            background: linear-gradient(135deg, #111116 0%, #0d1a12 100%);
            border: 1px solid rgba(0,255,65,0.15);
            border-radius: 22px; padding: 28px;
            position: relative; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5), inset 0 1px 0 rgba(0,255,65,0.1);
            margin-bottom: 20px;
            animation: slideUp 0.5s 0.1s ease both;
        }
        @keyframes slideUp { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:translateY(0); } }
        .wallet-card::before {
            content: ''; position: absolute; top: -60px; right: -60px;
            width: 200px; height: 200px; border-radius: 50%;
            background: radial-gradient(circle, rgba(0,255,65,0.08) 0%, transparent 70%);
        }
        .wallet-card::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(to right, transparent, rgba(0,255,65,0.2), transparent);
        }
        .wallet-label { font-size: 0.65rem; letter-spacing: 3px; text-transform: uppercase; color: #555; margin-bottom: 10px; }
        .wallet-amount {
            font-family: 'Bebas Neue', sans-serif; font-size: 3.5rem;
            color: var(--neon); line-height: 1;
            text-shadow: 0 0 40px rgba(0,255,65,0.3);
        }
        .wallet-currency { font-size: 1.5rem; opacity: 0.6; margin-right: 4px; }
        .wallet-meta { margin-top: 16px; display: flex; justify-content: space-between; align-items: flex-end; }
        .wallet-phone { font-size: 0.72rem; color: #444; }
        .wallet-phone span { color: #666; }
        .wallet-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 28px; animation: slideUp 0.5s 0.15s ease both; }
        .btn-action {
            padding: 14px; border-radius: 14px; border: none; font-weight: 700;
            font-size: 0.85rem; letter-spacing: 1px; cursor: pointer; font-family: 'Outfit', sans-serif;
            transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-action:hover { transform: translateY(-2px); }
        .btn-action:active { transform: translateY(0); opacity: 0.85; }
        .btn-deposit { background: var(--neon); color: #000; box-shadow: 0 6px 20px rgba(0,255,65,0.2); }
        .btn-deposit:hover { box-shadow: 0 10px 30px rgba(0,255,65,0.35); }
        .btn-withdraw { background: var(--card2); color: var(--text); border: 1px solid var(--border); }
        .section-header {
            display: flex; align-items: center; justify-content: space-between;
            margin-bottom: 14px; animation: slideUp 0.5s 0.2s ease both;
        }
        .section-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; letter-spacing: 2px; }
        .section-link { font-size: 0.78rem; color: var(--neon); cursor: pointer; font-weight: 500; }
        .quick-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 28px; animation: slideUp 0.5s 0.25s ease both; }
        .quick-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 18px 12px; text-align: center;
            cursor: pointer; transition: border-color 0.2s, transform 0.2s;
        }
        .quick-card:hover { border-color: rgba(0,255,65,0.3); transform: translateY(-2px); }
        .quick-icon { font-size: 1.5rem; margin-bottom: 8px; display: block; }
        .quick-label { font-size: 0.72rem; font-weight: 600; color: #ccc; letter-spacing: 0.5px; }
        .tournaments { animation: slideUp 0.5s 0.3s ease both; margin-bottom: 28px; }
        .tournament-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 18px; margin-bottom: 10px;
            cursor: pointer; transition: border-color 0.2s, transform 0.2s;
            position: relative; overflow: hidden;
        }
        .tournament-card:hover { border-color: rgba(0,255,65,0.25); transform: translateY(-1px); }
        .tournament-card.live::before {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0;
            width: 3px; background: var(--neon);
            box-shadow: 0 0 10px rgba(0,255,65,0.5);
        }
        .t-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
        .t-badge {
            display: inline-flex; align-items: center; gap: 5px;
            padding: 4px 10px; border-radius: 20px; font-size: 0.65rem;
            font-weight: 700; letter-spacing: 1px; text-transform: uppercase;
        }
        .t-badge.live-badge { background: rgba(0,255,65,0.1); color: var(--neon); border: 1px solid rgba(0,255,65,0.2); }
        .t-badge.soon-badge { background: rgba(255,180,0,0.1); color: #ffb400; border: 1px solid rgba(255,180,0,0.2); }
        .live-pip { width: 6px; height: 6px; background: var(--neon); border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }
        .t-name { font-weight: 700; font-size: 1rem; margin-bottom: 4px; }
        .t-meta { font-size: 0.78rem; color: var(--muted); }
        .t-footer { display: flex; justify-content: space-between; align-items: center; }
        .t-prize { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--neon); letter-spacing: 1px; }
        .t-prize small { font-family: 'Outfit', sans-serif; font-size: 0.65rem; color: var(--muted); font-weight: 400; display: block; letter-spacing: 0; margin-bottom: 1px; }
        .t-players { font-size: 0.75rem; color: var(--muted); display: flex; align-items: center; gap: 5px; }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.06); border-radius: 4px; margin-top: 12px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--neon); border-radius: 4px; transition: width 0.5s ease; }
        .btn-join {
            padding: 9px 20px; border-radius: 10px; background: var(--neon); color: #000;
            border: none; font-weight: 700; font-size: 0.78rem; cursor: pointer;
            font-family: 'Outfit', sans-serif; letter-spacing: 1px;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .btn-join:hover { transform: translateY(-1px); box-shadow: 0 5px 15px rgba(0,255,65,0.3); }
        .friend-section { animation: slideUp 0.5s 0.35s ease both; margin-bottom: 24px; }
        .friend-card {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 16px; padding: 20px;
        }
        .friend-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }
        .btn-friend {
            padding: 14px;
            border-radius: 14px;
            border: none;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            font-family: 'Outfit', sans-serif;
            transition: transform 0.15s, box-shadow 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn-friend:hover { transform: translateY(-2px); }
        .btn-friend-create {
            background: var(--neon);
            color: #000;
            box-shadow: 0 6px 20px rgba(0,255,65,0.2);
        }
        .btn-friend-create:hover { box-shadow: 0 10px 30px rgba(0,255,65,0.35); }
        .btn-friend-join {
            background: var(--card2);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .friend-info {
            background: rgba(0,255,65,0.05);
            border: 1px solid rgba(0,255,65,0.1);
            border-radius: 12px;
            padding: 14px;
            font-size: 0.75rem;
            color: #aaa;
            line-height: 1.6;
        }
        .my-matches-section { margin-top: 24px; }
        .match-item {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 10px;
        }
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .match-code {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.2rem;
            letter-spacing: 2px;
            color: var(--neon);
        }
        .match-status {
            font-size: 0.7rem;
            padding: 4px 10px;
            border-radius: 20px;
            background: rgba(255,180,0,0.1);
            color: #ffb400;
            text-transform: uppercase;
        }
        .match-detail {
            font-size: 0.85rem;
            color: #aaa;
            margin: 4px 0;
        }
        .match-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }
        /* NEW: Result Report Modal */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 500;
            background: rgba(0,0,0,0.75); backdrop-filter: blur(6px);
            display: flex; align-items: flex-end; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.25s ease;
        }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-sheet {
            background: #0f0f13; border: 1px solid var(--border);
            border-radius: 24px 24px 0 0; width: 100%; max-width: 480px;
            padding: 28px 24px 48px;
            transform: translateY(40px); transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
            position: relative;
        }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }
        .modal-handle {
            width: 36px; height: 4px; background: #2a2a2a; border-radius: 4px;
            margin: 0 auto 24px;
        }
        .modal-title { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; letter-spacing: 2px; margin-bottom: 6px; }
        .modal-subtitle { font-size: 0.85rem; color: var(--muted); margin-bottom: 24px; }
        .modal-input-group { margin-bottom: 16px; }
        .modal-input-group label {
            display: block; font-size: 0.68rem; letter-spacing: 2px;
            text-transform: uppercase; color: var(--muted); margin-bottom: 6px;
        }
        .modal-input {
            width: 100%; background: var(--card); border: 1px solid var(--border);
            color: var(--text); padding: 13px 16px; border-radius: 10px;
            font-size: 1rem; font-family: 'Outfit', sans-serif;
        }
        .btn-mpesa {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            background: #00a651; color: white; font-weight: 800; font-size: 0.9rem;
            cursor: pointer; font-family: 'Outfit', sans-serif;
        }
        .btn-cancel {
            width: 100%; padding: 13px; margin-top: 10px; border-radius: 12px;
            border: 1px solid var(--border); background: none; color: var(--muted);
            cursor: pointer;
        }
        .btn-cancel:hover { color: var(--text); border-color: #444; }
        .match-details-box {
            background: rgba(0,255,65,0.04); border: 1px solid rgba(0,255,65,0.12);
            border-radius: 14px; padding: 16px; margin-bottom: 18px;
        }
        .match-detail-row {
            display: flex; justify-content: space-between;
            padding: 7px 0; border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .match-detail-row:last-child { border-bottom: none; }
        .match-detail-label { font-size: 0.72rem; color: var(--muted); }
        .match-detail-value { font-size: 0.88rem; font-weight: 700; }
        .match-detail-value.neon { color: var(--neon); }
        .balance-insufficient {
            background: rgba(255,68,68,0.08); border: 1px solid rgba(255,68,68,0.2);
            border-radius: 10px; padding: 12px 14px; font-size: 0.82rem; color: #ff8888;
            margin-bottom: 14px; display: none;
        }

        /* ‚îÄ‚îÄ Bottom Nav ‚îÄ‚îÄ */
        .bottom-nav {
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%);
            width: 100%; max-width: 480px; background: rgba(10,10,14,0.95);
            border-top: 1px solid var(--border); backdrop-filter: blur(12px);
            display: flex; padding: 10px 0 18px; z-index: 20;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            gap: 5px; cursor: pointer; color: var(--muted); transition: color 0.2s;
        }
        .nav-item svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 1.8; }
        .nav-item-label { font-size: 0.6rem; letter-spacing: 0.5px; text-transform: uppercase; }
        .nav-item.active { color: var(--neon); }
        .nav-item.active svg { filter: drop-shadow(0 0 5px rgba(0,255,65,0.5)); }

        /* ‚îÄ‚îÄ Amount Presets ‚îÄ‚îÄ */
        .amount-presets { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 14px; }
        .preset-btn {
            padding: 9px 6px; background: var(--card); border: 1px solid var(--border);
            border-radius: 10px; color: var(--text); font-size: 0.8rem; font-weight: 600;
            cursor: pointer; font-family: 'Outfit', sans-serif; transition: all 0.2s;
        }
        .preset-btn:hover, .preset-btn.selected {
            border-color: var(--neon); color: var(--neon); background: rgba(0,255,65,0.06);
        }

        /* ‚îÄ‚îÄ Match status badges ‚îÄ‚îÄ */
        .status-pending { background: rgba(255,180,0,0.1); color: #ffb400; border: 1px solid rgba(255,180,0,0.2); border-radius: 20px; padding: 3px 10px; font-size: 0.65rem; text-transform: uppercase; }
        .status-live { background: rgba(0,255,65,0.1); color: var(--neon); border: 1px solid rgba(0,255,65,0.2); border-radius: 20px; padding: 3px 10px; font-size: 0.65rem; text-transform: uppercase; }
        .status-disputed { background: rgba(255,68,68,0.1); color: #ff6666; border: 1px solid rgba(255,68,68,0.2); border-radius: 20px; padding: 3px 10px; font-size: 0.65rem; text-transform: uppercase; }
        .status-closed { background: rgba(100,100,100,0.1); color: #777; border: 1px solid rgba(100,100,100,0.2); border-radius: 20px; padding: 3px 10px; font-size: 0.65rem; text-transform: uppercase; }

        /* ‚îÄ‚îÄ Balance flash ‚îÄ‚îÄ */
        @keyframes balFlash { 0%,100%{color:var(--neon);} 50%{color:#fff; text-shadow:0 0 20px #fff;} }
        .balance-flash { animation: balFlash 0.6s ease; }

        /* ‚îÄ‚îÄ Breakdown box ‚îÄ‚îÄ */
        .breakdown-box {
            background: rgba(0,255,65,0.04); border: 1px solid rgba(0,255,65,0.12);
            border-radius: 12px; padding: 14px; margin: 14px 0;
        }
        .breakdown-row {
            display: flex; justify-content: space-between;
            font-size: 0.8rem; color: #aaa; padding: 4px 0;
        }
        .breakdown-row.total { color: var(--neon); font-weight: 700; font-size: 0.9rem; border-top: 1px solid rgba(0,255,65,0.15); margin-top: 6px; padding-top: 10px; }

        /* ‚îÄ‚îÄ Step system ‚îÄ‚îÄ */
        .step { display: none; }
        .step.active { display: block; }

        /* ‚îÄ‚îÄ Misc buttons ‚îÄ‚îÄ */
        .btn { padding: 10px 18px; border-radius: 10px; font-weight: 700; font-size: 0.82rem; cursor: pointer; font-family: 'Outfit', sans-serif; border: none; transition: all 0.2s; }
        .btn-green { background: var(--neon); color: #000; }
        .btn-red { background: rgba(255,68,68,0.15); color: #ff6666; border: 1px solid rgba(255,68,68,0.3); }
        .matches-list { min-height: 60px; }
        .modal-select { width: 100%; background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 13px 16px; border-radius: 10px; font-size: 1rem; font-family: 'Outfit', sans-serif; }
    </style>
</head>
<body>
<div id="loading-screen">
    <div class="spinner"></div>
    <div class="loading-text">Verifying session...</div>
</div>

<div class="pitch-bg"></div>
<div class="pitch-lines"></div>

<div class="app" id="main-content" style="display:none;">
    <nav class="topnav">
        <span class="nav-logo">VUMBUA</span>
        <div class="nav-right">
            <div class="nav-user">
                <div class="avatar" id="avatar-letter">P</div>
                <span class="nav-username" id="username-display">@Player</span>
            </div>
            <button class="btn-logout" id="logoutBtn">Logout</button>
        </div>
    </nav>
    <div class="content">
        <div class="wallet-card">
            <div class="wallet-label">Available Balance</div>
            <div class="wallet-amount">
                <span class="wallet-currency">KES</span><span id="balance">0.00</span>
            </div>
            <div class="wallet-meta">
                <div class="wallet-phone">Linked M-PESA: <span id="phone-display">‚Äî</span></div>
            </div>
        </div>
        <div class="wallet-actions">
            <button class="btn-action btn-deposit" onclick="openDepositModal()">
                <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
                Deposit
            </button>
            <button class="btn-action btn-withdraw" onclick="openWithdrawModal()">
                <svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                Withdraw
            </button>
        </div>

        <div class="section-header">
            <div class="section-title">QUICK PLAY</div>
        </div>
        <div class="quick-grid">
            <div class="quick-card" onclick="document.querySelector('.friend-section').scrollIntoView({behavior: 'smooth'})">
                <span class="quick-icon">‚öîÔ∏è</span>
                <div class="quick-label">Piga Rafiki</div>
            </div>
            <div class="quick-card">
                <span class="quick-icon">üèÜ</span>
                <div class="quick-label">Tournaments</div>
            </div>
            <div class="quick-card">
                <span class="quick-icon">üìä</span>
                <div class="quick-label">Matokeo</div>
            </div>
        </div>

        <div class="tournaments">
            <div class="section-header">
                <div class="section-title">LIVE NOW</div>
                <span class="section-link" onclick="loadTournaments()">Ona zote ‚Üí</span>
            </div>
            <div id="tournament-list">
                <!-- Tournament cards will be injected safely via JS -->
            </div>
        </div>

        <div class="friend-section">
            <div class="section-header">
                <div class="section-title">CHALLENGE RAFIKI</div>
            </div>
            <div class="friend-card">
                <div class="friend-buttons">
                    <button class="btn-friend btn-friend-create" onclick="openCreateMatchModal()">
                        ‚öîÔ∏è Create Challenge
                    </button>
                    <button class="btn-friend btn-friend-join" onclick="openJoinMatchModal()">
                        üéØ Join Challenge
                    </button>
                </div>
                <div class="friend-info">
                    üí∞ Both players stake equal amounts<br/>
                    üèÜ Winner takes the pot (minus 10% fee)<br/>
                    ‚è±Ô∏è Match codes expire in 30 minutes
                </div>
            </div>
        </div>

        <!-- MY MATCHES SECTION -->
        <div class="my-matches-section">
            <div class="section-header">
                <div class="section-title">MY MATCHES</div>
                <span class="section-link" onclick="loadMyFriendMatches()">Refresh ‚Üª</span>
            </div>
            <div id="my-matches-list" class="matches-list">
                <!-- Dynamically loaded -->
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav">
    <div class="nav-item active">
        <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <span class="nav-item-label">Home</span>
    </div>
    <div class="nav-item">
        <svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <span class="nav-item-label">Chat</span>
    </div>
    <div class="nav-item">
        <svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="3" y1="9" x2="21" y2="9"></line><line x1="9" y1="21" x2="9" y2="9"></line></svg>
        <span class="nav-item-label">Matches</span>
    </div>
    <div class="nav-item">
        <svg viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
        <span class="nav-item-label">Profile</span>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê DEPOSIT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="deposit-modal" onclick="if(event.target === this) closeModal('deposit-modal')">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title">DEPOSIT</div>
        <p class="modal-subtitle">Top up via M-PESA STK Push</p>

        <div class="step active" id="deposit-step-1">
            <div class="modal-input-group">
                <label>Amount (KES)</label>
                <div class="amount-presets">
                    <button class="preset-btn" onclick="selectPreset(this,100)">100</button>
                    <button class="preset-btn" onclick="selectPreset(this,200)">200</button>
                    <button class="preset-btn" onclick="selectPreset(this,500)">500</button>
                    <button class="preset-btn" onclick="selectPreset(this,1000)">1000</button>
                </div>
                <input type="number" id="deposit-amount" class="modal-input" placeholder="Enter amount" min="10">
            </div>
            <div class="modal-input-group">
                <label>M-PESA Number</label>
                <input type="tel" id="deposit-phone" class="modal-input" placeholder="07XX XXX XXX">
            </div>
            <div class="balance-insufficient" id="deposit-error"></div>
            <button class="btn-mpesa" onclick="processDeposit()">PAY WITH M-PESA üì≤</button>
            <button class="btn-cancel" onclick="closeModal('deposit-modal')">Cancel</button>
        </div>

        <div class="step" id="deposit-step-2">
            <div class="friend-info" style="text-align:center; margin-bottom:20px;">
                <div style="font-size:2rem; margin-bottom:10px;">üì≤</div>
                <strong style="color:var(--text);">Check your phone!</strong><br>
                An M-PESA prompt has been sent. Enter your PIN to complete the payment.
            </div>
            <div style="text-align:center; color:var(--muted); font-size:0.8rem; margin-bottom:20px;" id="deposit-status-text">Waiting for payment...</div>
            <button class="btn-cancel" onclick="closeModal('deposit-modal')">Cancel</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê WITHDRAW MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="withdraw-modal" onclick="if(event.target === this) closeModal('withdraw-modal')">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title">WITHDRAW</div>
        <p class="modal-subtitle">Send winnings to your M-PESA</p>
        <div class="modal-input-group">
            <label>Amount (KES)</label>
            <input type="number" id="withdraw-amount" class="modal-input" placeholder="Enter amount" min="50">
        </div>
        <div class="modal-input-group">
            <label>M-PESA Number</label>
            <input type="tel" id="withdraw-phone" class="modal-input" placeholder="07XX XXX XXX">
        </div>
        <div class="balance-insufficient" id="withdraw-error"></div>
        <button class="btn-mpesa" onclick="processWithdraw()">WITHDRAW NOW ‚Üí</button>
        <button class="btn-cancel" onclick="closeModal('withdraw-modal')">Cancel</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê TOURNAMENT JOIN / CHALLENGE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="challenge-modal" onclick="if(event.target === this) closeModal('challenge-modal')">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title" id="challenge-title">JOIN TOURNAMENT</div>
        <p class="modal-subtitle">Choose how to pay the entry fee</p>

        <div class="step active" id="challenge-step-1">
            <div class="match-details-box">
                <div class="match-detail-row"><span class="match-detail-label">Tournament</span><span class="match-detail-value" id="challenge-name">‚Äî</span></div>
                <div class="match-detail-row"><span class="match-detail-label">Entry Fee</span><span class="match-detail-value neon" id="challenge-fee">KES 0</span></div>
            </div>
            <div class="balance-insufficient" id="challenge-error"></div>
            <button class="btn-mpesa" style="background:var(--neon);color:#000;margin-bottom:10px;" onclick="confirmChallenge('wallet')">PAY FROM WALLET üí∞</button>
            <button class="btn-mpesa" onclick="confirmChallenge('mpesa')">PAY WITH M-PESA üì≤</button>
            <button class="btn-cancel" onclick="closeModal('challenge-modal')">Cancel</button>
        </div>

        <div class="step" id="challenge-step-2">
            <div class="friend-info" style="text-align:center; margin-bottom:20px;">
                <div style="font-size:2rem; margin-bottom:10px;">üì≤</div>
                Check your phone for the M-PESA prompt. Enter your PIN to complete.
            </div>
            <div style="text-align:center; color:var(--muted); font-size:0.8rem; margin-bottom:20px;" id="challenge-status">Waiting for payment...</div>
            <button class="btn-cancel" onclick="closeModal('challenge-modal')">Cancel</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê ROOM CODE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="room-modal" onclick="if(event.target === this) closeModal('room-modal')">
    <div class="modal-sheet" style="text-align:center;">
        <div class="modal-handle"></div>
        <div class="modal-title">YOU'RE IN! üèÜ</div>
        <p class="modal-subtitle">Use this code to enter the game room</p>
        <div style="font-family:'Bebas Neue',sans-serif; font-size:3.5rem; color:var(--neon); letter-spacing:8px; margin:20px 0; text-shadow:0 0 30px rgba(0,255,65,0.4);" id="room-code-display">‚Äî</div>
        <button class="btn-mpesa" style="background:var(--neon);color:#000;margin-bottom:10px;" onclick="shareRoomCode()">üì≤ Share via WhatsApp</button>
        <button class="btn-cancel" onclick="closeModal('room-modal')">Close</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê CREATE FRIEND MATCH MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="create-friend-modal" onclick="if(event.target === this) closeModal('create-friend-modal')">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title">CREATE CHALLENGE ‚öîÔ∏è</div>
        <p class="modal-subtitle">Set your wager. Both players stake equal amounts.</p>
        <div class="modal-input-group">
            <label>Your Wager (KES)</label>
            <div class="amount-presets">
                <button class="preset-btn" onclick="selectFriendPreset(this,50)">50</button>
                <button class="preset-btn" onclick="selectFriendPreset(this,100)">100</button>
                <button class="preset-btn selected" onclick="selectFriendPreset(this,200)">200</button>
                <button class="preset-btn" onclick="selectFriendPreset(this,500)">500</button>
            </div>
            <input type="number" id="friend-wager-input" class="modal-input" value="200" min="50" oninput="updateFriendBreakdown()">
        </div>
        <div class="breakdown-box">
            <div class="breakdown-row"><span>Your stake</span><span>KES <span id="friend-your-stake">200</span></span></div>
            <div class="breakdown-row"><span>Opponent's stake</span><span>KES <span id="friend-opp-stake">200</span></span></div>
            <div class="breakdown-row"><span>Total pot</span><span>KES <span id="friend-total-pot">400</span></span></div>
            <div class="breakdown-row"><span>Platform fee (10%)</span><span>- KES <span id="friend-platform-fee">40</span></span></div>
            <div class="breakdown-row total"><span>Winner gets</span><span>KES <span id="friend-winner-prize">360</span></span></div>
        </div>
        <div class="balance-insufficient" id="create-friend-error"></div>
        <button class="btn-mpesa" id="create-friend-btn" style="background:var(--neon);color:#000;" onclick="createFriendMatch()">
            CREATE CHALLENGE (Pay KES <span id="create-friend-amount">200</span>)
        </button>
        <button class="btn-cancel" onclick="closeModal('create-friend-modal')">Cancel</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê WAITING FOR OPPONENT MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="waiting-friend-modal">
    <div class="modal-sheet" style="text-align:center;">
        <div class="modal-handle"></div>
        <div class="modal-title">WAITING FOR OPPONENT ‚è≥</div>
        <p class="modal-subtitle" id="friend-match-timer">Expires in 30:00</p>
        <div style="font-family:'Bebas Neue',sans-serif; font-size:3rem; color:var(--neon); letter-spacing:8px; margin:20px 0; text-shadow:0 0 30px rgba(0,255,65,0.4);" id="friend-match-code">VUM-XXXX</div>
        <div class="friend-info" style="margin-bottom:20px;">
            Your wager: KES <strong id="waiting-stake-display">0</strong> ¬∑ Winner gets: KES <strong id="waiting-prize-display">0</strong>
        </div>
        <button class="btn-mpesa" style="background:var(--neon);color:#000;margin-bottom:10px;" onclick="shareFriendCode()">üì≤ Share Code via WhatsApp</button>
        <button class="btn-cancel" onclick="cancelFriendMatch()">Cancel Match (Refund)</button>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê JOIN FRIEND MATCH MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="join-friend-modal" onclick="if(event.target === this) closeModal('join-friend-modal')">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title">JOIN CHALLENGE üéØ</div>
        <p class="modal-subtitle">Enter the match code your opponent shared.</p>
        <div class="modal-input-group">
            <label>Match Code</label>
            <input type="text" id="join-friend-code" class="modal-input" placeholder="VUM-XXXX" style="text-transform:uppercase; letter-spacing:4px; font-size:1.3rem; text-align:center;" maxlength="8">
        </div>
        <div class="balance-insufficient" id="join-friend-error"></div>
        <button class="btn-mpesa" style="background:var(--neon);color:#000;" onclick="joinFriendMatch()">JOIN & PAY WAGER</button>
        <button class="btn-cancel" onclick="closeModal('join-friend-modal')">Cancel</button>
    </div>
</div>

<!-- Report Result Modal -->
<div class="modal-overlay" id="report-result-modal" onclick="if(event.target === this) closeModal('report-result-modal')">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title">REPORT MATCH RESULT</div>
        <p class="modal-subtitle">Who won? (Both players must agree)</p>
        <div class="match-details-box" id="report-match-details">
            <!-- filled by JS -->
        </div>
        <div class="modal-input-group">
            <label>Select Winner</label>
            <select id="report-winner" class="modal-input">
                <option value="">-- Choose winner --</option>
            </select>
        </div>
        <div class="modal-input-group">
            <label>Screenshot URL (optional)</label>
            <input type="url" id="report-screenshot" class="modal-input" placeholder="https://...">
        </div>
        <div class="balance-insufficient" id="report-error"></div>
        <button class="btn-mpesa" onclick="submitMatchResult()">SUBMIT RESULT</button>
        <button class="btn-cancel" onclick="closeModal('report-result-modal')">Cancel</button>
    </div>
</div>

<script>
    // --- Escape function for XSS prevention ---
    function escapeHtml(unsafe) {
        if (unsafe === null || unsafe === undefined) return '';
        return String(unsafe)
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // --- Helper to safely create elements with text content ---
    function createElementSafe(tag, attributes = {}, textContent = '') {
        const el = document.createElement(tag);
        Object.entries(attributes).forEach(([key, value]) => el.setAttribute(key, value));
        if (textContent) el.textContent = escapeHtml(textContent);
        return el;
    }

    // --- Global variables ---
    let authToken = localStorage.getItem('supabaseToken');
    let currentUser = null;
    let currentBalance = 0;
    let currentPhone = '';
    let currentUsername = '';
    let currentCheckoutId = null;
    let pollInterval = null;
    let currentFriendMatch = null;
    let friendMatchTimer = null;
    let currentReportMatch = null;
    let currentTournamentId = null, currentTournamentFee = 0, currentTournamentName = '';

    // --- Utility functions ---
    function showError(elementId, message) {
        const el = document.getElementById(elementId);
        if (el) { el.textContent = escapeHtml(message); el.style.display = 'block'; }
    }
    function hideError(elementId) {
        const el = document.getElementById(elementId);
        if (el) el.style.display = 'none';
    }
    async function fetchWithAuth(url, options = {}) {
        if (!authToken) { window.location.href = '/login'; return; }
        const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`,
            ...options.headers
        };
        const res = await fetch(url, { ...options, headers });
        if (res.status === 401) {
            localStorage.removeItem('supabaseToken');
            localStorage.removeItem('supabaseUser');
            window.location.href = '/login';
            return;
        }
        return res;
    }

    // --- Load user data and balance ---
    async function loadDashboard() {
        try {
            const userStr = localStorage.getItem('supabaseUser');
            if (!userStr) { window.location.href = '/login'; return; }
            currentUser = JSON.parse(userStr);
            currentUsername = currentUser.user_metadata?.username || currentUser.phone?.substring(0,8) || 'Player';
            document.getElementById('username-display').innerText = '@' + currentUsername;
            document.getElementById('avatar-letter').innerText = currentUsername.charAt(0).toUpperCase();
            if (currentUser.phone) {
                let phone = currentUser.phone.replace('+254', '0');
                document.getElementById('phone-display').innerText = phone;
                currentPhone = phone;
                const dPhone = document.getElementById('deposit-phone');
                const wPhone = document.getElementById('withdraw-phone');
                if (dPhone) dPhone.value = phone;
                if (wPhone) wPhone.value = phone;
            }
            await refreshBalance();
            loadTournaments();
            loadMyFriendMatches();
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        } catch (err) {
            console.error('Failed to load dashboard', err);
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        }
    }

    async function refreshBalance() {
        const res = await fetchWithAuth('/wallet/balance');
        if (!res) return;
        const data = await res.json();
        currentBalance = data.balance || 0;
        updateBalanceDisplay();
    }

    function updateBalanceDisplay() {
        const balElement = document.getElementById('balance');
        balElement.innerText = currentBalance.toFixed(2);
        balElement.classList.remove('balance-flash');
        void balElement.offsetWidth;
        balElement.classList.add('balance-flash');
    }

    // --- TOURNAMENTS (Safe DOM) ---
    async function loadTournaments() {
        try {
            const res = await fetch('/tournaments');
            if (!res.ok) throw new Error('Failed to load tournaments');
            const tournaments = await res.json();
            renderTournaments(tournaments);
        } catch (err) {
            console.error('Error loading tournaments:', err);
            const container = document.getElementById('tournament-list');
            container.innerHTML = '';
            container.appendChild(createElementSafe('div', { class: 'tournament-card' }, 'No active tournaments right now.'));
        }
    }

    function renderTournaments(tournaments) {
        const container = document.getElementById('tournament-list');
        container.innerHTML = '';
        if (!tournaments || tournaments.length === 0) {
            container.appendChild(createElementSafe('div', { class: 'tournament-card' }, 'No active tournaments right now.'));
            return;
        }

        tournaments.forEach(t => {
            const card = createElementSafe('div', { class: `tournament-card ${t.status === 'live' ? 'live' : ''}` });
            card.addEventListener('click', () => openChallengeModal(t.id, t.name, t.entry_fee));

            // Header
            const headerDiv = createElementSafe('div', { class: 't-header' });
            const titleDiv = createElementSafe('div', {});
            titleDiv.appendChild(createElementSafe('div', { class: 't-name' }, t.name));
            const startTime = new Date(t.start_time).toLocaleDateString('en-KE', { weekday: 'short', hour: '2-digit', minute: '2-digit' });
            titleDiv.appendChild(createElementSafe('div', { class: 't-meta' }, `Starts ${startTime}`));
            headerDiv.appendChild(titleDiv);

            const badgeSpan = document.createElement('span');
            badgeSpan.className = `t-badge ${t.status === 'live' ? 'live-badge' : 'soon-badge'}`;
            if (t.status === 'live') {
                const pip = document.createElement('span');
                pip.className = 'live-pip';
                badgeSpan.appendChild(pip);
                badgeSpan.appendChild(document.createTextNode(' LIVE'));
            } else {
                badgeSpan.textContent = 'üóì SOON';
            }
            headerDiv.appendChild(badgeSpan);
            card.appendChild(headerDiv);

            // Footer
            const footerDiv = createElementSafe('div', { class: 't-footer' });
            const prizeDiv = createElementSafe('div', { class: 't-prize' });
            prizeDiv.appendChild(createElementSafe('small', {}, 'PRIZE POOL'));
            prizeDiv.appendChild(document.createTextNode(`KES ${(t.prize_pool || 0).toLocaleString()}`));
            footerDiv.appendChild(prizeDiv);

            const rightDiv = createElementSafe('div', { style: 'display:flex;flex-direction:column;align-items:flex-end;gap:8px;' });
            rightDiv.appendChild(createElementSafe('div', { class: 't-players' }, `üë• ${t.current_players}/${t.max_players}`));
            const joinBtn = createElementSafe('button', { class: 'btn-join' }, `KES ${t.entry_fee} ‚Üí`);
            rightDiv.appendChild(joinBtn);
            footerDiv.appendChild(rightDiv);
            card.appendChild(footerDiv);

            // Progress
            const pct = t.max_players > 0 ? Math.round((t.current_players / t.max_players) * 100) : 0;
            const progressDiv = createElementSafe('div', { class: 'progress-bar' });
            progressDiv.appendChild(createElementSafe('div', { class: 'progress-fill', style: `width:${pct}%` }));
            card.appendChild(progressDiv);

            container.appendChild(card);
        });
    }

    // --- Modal Helpers ---
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('open');
        if (modalId === 'deposit-modal' && pollInterval) { clearInterval(pollInterval); pollInterval = null; }
        if (modalId === 'waiting-friend-modal' && friendMatchTimer) { clearInterval(friendMatchTimer); friendMatchTimer = null; }
        if (modalId === 'report-result-modal') currentReportMatch = null;
    }
    function switchStep(modalId, stepNum) {
        document.querySelectorAll(`#${modalId} .step`).forEach((s, i) => {
            s.classList.toggle('active', i + 1 === stepNum);
        });
    }

    // --- Deposit Flow ---
    function openDepositModal() {
        hideError('deposit-error');
        switchStep('deposit-modal', 1);
        document.getElementById('deposit-amount').value = '';
        document.getElementById('deposit-modal').classList.add('open');
    }
    function selectPreset(btn, amount) {
        document.querySelectorAll('#deposit-modal .preset-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('deposit-amount').value = amount;
    }
    async function processDeposit() {
        const amount = parseInt(document.getElementById('deposit-amount').value);
        const phone = document.getElementById('deposit-phone').value.trim();
        if (!amount || amount < 10) { showError('deposit-error', 'Minimum deposit is KES 10'); return; }
        if (!phone) { showError('deposit-error', 'Enter your M-PESA number'); return; }

        let cleanPhone = phone.replace(/\s+/g, '');
        if (cleanPhone.startsWith('0')) cleanPhone = '+254' + cleanPhone.substring(1);

        const btn = document.querySelector('#deposit-modal .btn-mpesa');
        btn.disabled = true; btn.textContent = 'Sending request...';
        try {
            const res = await fetchWithAuth('/wallet/deposit', {
                method: 'POST',
                body: JSON.stringify({ amount, phone: cleanPhone })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            currentCheckoutId = data.checkoutRequestId;
            switchStep('deposit-modal', 2);
            pollInterval = setInterval(() => checkDepositStatus(currentCheckoutId), 3000);
        } catch (err) {
            showError('deposit-error', err.message);
        } finally {
            btn.disabled = false; btn.textContent = 'PAY WITH M-PESA üì≤';
        }
    }
    async function checkDepositStatus(checkoutId) {
        try {
            const res = await fetchWithAuth(`/wallet/deposit/status?checkoutId=${checkoutId}`);
            if (!res) return;
            const data = await res.json();
            if (data.status === 'completed') {
                clearInterval(pollInterval); pollInterval = null;
                closeModal('deposit-modal');
                await refreshBalance();
                alert('‚úÖ Deposit successful! Your balance has been updated.');
            } else if (data.status === 'failed') {
                clearInterval(pollInterval); pollInterval = null;
                switchStep('deposit-modal', 1);
                showError('deposit-error', 'Payment failed or cancelled. Try again.');
            }
        } catch (err) { /* keep polling */ }
    }

    // --- Withdraw Flow ---
    function openWithdrawModal() {
        hideError('withdraw-error');
        document.getElementById('withdraw-amount').value = '';
        document.getElementById('withdraw-modal').classList.add('open');
    }
    async function processWithdraw() {
        const amount = parseInt(document.getElementById('withdraw-amount').value);
        const phone = document.getElementById('withdraw-phone').value.trim();
        if (!amount || amount < 50) { showError('withdraw-error', 'Minimum withdrawal is KES 50'); return; }
        if (amount > currentBalance) { showError('withdraw-error', 'Insufficient balance'); return; }
        if (!phone) { showError('withdraw-error', 'Enter your M-PESA number'); return; }

        let cleanPhone = phone.replace(/\s+/g, '');
        if (cleanPhone.startsWith('0')) cleanPhone = '+254' + cleanPhone.substring(1);

        const btn = document.querySelector('#withdraw-modal .btn-mpesa');
        btn.disabled = true; btn.textContent = 'Processing...';
        try {
            const res = await fetchWithAuth('/wallet/withdraw', {
                method: 'POST',
                body: JSON.stringify({ amount, phone: cleanPhone })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            closeModal('withdraw-modal');
            await refreshBalance();
            alert(`‚úÖ Withdrawal of KES ${amount} submitted! You'll receive an M-PESA shortly.`);
        } catch (err) {
            showError('withdraw-error', err.message);
        } finally {
            btn.disabled = false; btn.textContent = 'WITHDRAW NOW ‚Üí';
        }
    }

    // --- Tournament/Challenge Flow ---
    function openChallengeModal(tournamentId, name, fee) {
        currentTournamentId = tournamentId;
        currentTournamentFee = fee;
        currentTournamentName = name;
        document.getElementById('challenge-name').textContent = escapeHtml(name);
        document.getElementById('challenge-fee').textContent = `KES ${fee}`;
        hideError('challenge-error');
        switchStep('challenge-modal', 1);
        document.getElementById('challenge-modal').classList.add('open');
    }
    async function confirmChallenge(method) {
        if (!currentTournamentId) return;

        if (method === 'wallet' && currentBalance < currentTournamentFee) {
            showError('challenge-error', 'Insufficient balance. Please deposit first.');
            return;
        }

        if (method === 'mpesa') {
            switchStep('challenge-modal', 2);
            try {
                const payRes = await fetchWithAuth('/wallet/deposit', {
                    method: 'POST',
                    body: JSON.stringify({ amount: currentTournamentFee, phone: '+254' + currentPhone.replace(/^0/, '') })
                });
                const payData = await payRes.json();
                if (!payRes.ok) { switchStep('challenge-modal', 1); showError('challenge-error', payData.error); return; }
                currentCheckoutId = payData.checkoutRequestId;
                pollInterval = setInterval(async () => {
                    try {
                        const sRes = await fetchWithAuth(`/wallet/deposit/status?checkoutId=${currentCheckoutId}`);
                        if (!sRes) return;
                        const sData = await sRes.json();
                        if (sData.status === 'completed') {
                            clearInterval(pollInterval); pollInterval = null;
                            await doJoinTournament('mpesa', currentCheckoutId);
                        } else if (sData.status === 'failed') {
                            clearInterval(pollInterval); pollInterval = null;
                            switchStep('challenge-modal', 1);
                            showError('challenge-error', 'M-PESA payment failed.');
                        }
                    } catch(e) {}
                }, 3000);
            } catch(err) {
                switchStep('challenge-modal', 1);
                showError('challenge-error', err.message);
            }
            return;
        }

        await doJoinTournament('wallet', null);
    }
    async function doJoinTournament(paymentMethod, checkoutId) {
        try {
            const res = await fetchWithAuth('/tournament/join', {
                method: 'POST',
                body: JSON.stringify({
                    tournamentId: currentTournamentId,
                    entryFee: currentTournamentFee,
                    paymentMethod,
                    checkoutId
                })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            closeModal('challenge-modal');
            if (paymentMethod === 'wallet') { currentBalance -= currentTournamentFee; updateBalanceDisplay(); }
            if (data.roomCode) {
                document.getElementById('room-code-display').textContent = data.roomCode;
                document.getElementById('room-modal').classList.add('open');
            } else {
                alert(`‚úÖ ${data.message || 'Umejiunga!'}`);
            }
            await loadTournaments();
        } catch (err) {
            switchStep('challenge-modal', 1);
            showError('challenge-error', err.message);
        }
    }

    // --- Friend Match Functions ---
    function openCreateMatchModal() {
        document.getElementById('friend-wager-input').value = 100;
        updateFriendBreakdown();
        hideError('create-friend-error');
        document.getElementById('create-friend-modal').classList.add('open');
    }
    function openJoinMatchModal() {
        document.getElementById('join-friend-code').value = '';
        hideError('join-friend-error');
        document.getElementById('join-friend-modal').classList.add('open');
    }
    function selectFriendPreset(btn, amount) {
        document.querySelectorAll('#create-friend-modal .preset-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        document.getElementById('friend-wager-input').value = amount;
        updateFriendBreakdown();
    }
    function updateFriendBreakdown() {
        const wager = parseInt(document.getElementById('friend-wager-input').value) || 100;
        const platformFee = Math.floor(wager * 2 * 0.10);
        const winnerPrize = (wager * 2) - platformFee;
        document.getElementById('friend-your-stake').textContent = wager;
        document.getElementById('friend-opp-stake').textContent = wager;
        document.getElementById('friend-total-pot').textContent = wager * 2;
        document.getElementById('friend-platform-fee').textContent = platformFee;
        document.getElementById('friend-winner-prize').textContent = winnerPrize;
        document.getElementById('create-friend-amount').textContent = wager;
    }
    async function createFriendMatch() {
        const wagerAmount = parseInt(document.getElementById('friend-wager-input').value);
        const errorEl = document.getElementById('create-friend-error');
        const btn = document.getElementById('create-friend-btn');
        if (wagerAmount < 50) { showError('create-friend-error', 'Minimum wager is KES 50'); return; }
        if (wagerAmount > currentBalance) { showError('create-friend-error', 'Insufficient balance'); return; }
        btn.disabled = true;
        btn.textContent = 'Creating...';
        try {
            const res = await fetchWithAuth('/friends/create-match', {
                method: 'POST',
                body: JSON.stringify({ wagerAmount })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            currentFriendMatch = data;
            currentBalance -= wagerAmount;
            updateBalanceDisplay();
            document.getElementById('friend-match-code').textContent = data.matchCode;
            document.getElementById('waiting-stake-display').textContent = wagerAmount;
            document.getElementById('waiting-prize-display').textContent = data.winnerPrize;
            startFriendTimer(data.expiresAt);
            closeModal('create-friend-modal');
            document.getElementById('waiting-friend-modal').classList.add('open');
            await loadMyFriendMatches();
        } catch (err) {
            showError('create-friend-error', err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = 'CREATE CHALLENGE (Pay KES <span id="create-friend-amount">' + wagerAmount + '</span>)';
        }
    }
    async function joinFriendMatch() {
        const matchCode = document.getElementById('join-friend-code').value.trim().toUpperCase();
        const errorEl = document.getElementById('join-friend-error');
        if (!matchCode) { showError('join-friend-error', 'Please enter a match code'); return; }
        try {
            const res = await fetchWithAuth('/friends/join-match', {
                method: 'POST',
                body: JSON.stringify({ matchCode })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            currentBalance -= data.wagerAmount;
            updateBalanceDisplay();
            currentFriendMatch = data;
            closeModal('join-friend-modal');
            alert(`Match joined! Play now. Winner gets KES ${data.winnerPrize}`);
            await loadMyFriendMatches();
        } catch (err) {
            showError('join-friend-error', err.message);
        }
    }
    async function cancelFriendMatch() {
        if (!confirm('Are you sure you want to cancel? You\'ll get your wager back.')) return;
        try {
            const res = await fetchWithAuth('/friends/cancel-match', {
                method: 'POST',
                body: JSON.stringify({ matchId: currentFriendMatch.matchId })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            currentBalance += data.refundedAmount;
            updateBalanceDisplay();
            if (friendMatchTimer) { clearInterval(friendMatchTimer); friendMatchTimer = null; }
            closeModal('waiting-friend-modal');
            alert(`Match cancelled. KES ${data.refundedAmount} refunded.`);
            await loadMyFriendMatches();
        } catch (err) {
            alert(err.message);
        }
    }
    function shareFriendCode() {
        const code = document.getElementById('friend-match-code').textContent;
        const wager = parseInt(document.getElementById('waiting-stake-display').textContent);
        const prize = parseInt(document.getElementById('waiting-prize-display').textContent);
        const text = encodeURIComponent(
            `üéÆ Challenge me on Vumbua eFootball!\n\nMatch Code: ${code}\nWager: KES ${wager}\nWinner gets: KES ${prize}\n\nJoin here: https://vumbua.app`
        );
        window.open(`https://wa.me/?text=${text}`, '_blank');
    }
    function startFriendTimer(expiresAt) {
        if (friendMatchTimer) clearInterval(friendMatchTimer);
        friendMatchTimer = setInterval(() => {
            const now = new Date();
            const expires = new Date(expiresAt);
            const diff = Math.max(0, expires - now);
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            document.getElementById('friend-match-timer').textContent = 
                `Expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
            if (diff === 0) {
                clearInterval(friendMatchTimer);
                closeModal('waiting-friend-modal');
                alert('Match expired. Your wager has been refunded.');
                refreshBalance();
                loadMyFriendMatches();
            }
        }, 1000);
    }

    // --- My Matches & Result Reporting (Safe DOM) ---
    async function loadMyFriendMatches() {
        const res = await fetchWithAuth('/friends/my-matches');
        if (!res) return;
        const matches = await res.json();
        renderMyMatches(matches);
    }

    function renderMyMatches(matches) {
        const container = document.getElementById('my-matches-list');
        container.innerHTML = '';
        if (!matches || matches.length === 0) {
            container.appendChild(createElementSafe('div', { class: 'friend-info', style: 'text-align:center;' }, 'No matches yet. Create or join one!'));
            return;
        }

        matches.forEach(m => {
            const item = createElementSafe('div', { class: 'match-item' });

            // Header
            const headerDiv = createElementSafe('div', { class: 'match-header' });
            headerDiv.appendChild(createElementSafe('span', { class: 'match-code' }, m.match_code));
            const statusSpan = createElementSafe('span', { class: `match-status status-${m.status}` }, m.status);
            headerDiv.appendChild(statusSpan);
            item.appendChild(headerDiv);

            // Details
            item.appendChild(createElementSafe('div', { class: 'match-detail' }, `Wager: KES ${m.wager_amount}`));
            item.appendChild(createElementSafe('div', { class: 'match-detail' }, `Winner prize: KES ${m.winner_prize}`));
            const opponentName = (m.creator_id === currentUser.id)
                ? (m.joiner?.username || 'Waiting...')
                : (m.creator?.username || 'Unknown');
            item.appendChild(createElementSafe('div', { class: 'match-detail' }, `Opponent: ${opponentName}`));

            // Actions
            if (m.status === 'pending' && m.creator_id === currentUser.id) {
                const actionsDiv = createElementSafe('div', { class: 'match-actions' });
                const cancelBtn = createElementSafe('button', { class: 'btn btn-red' }, 'Cancel');
                cancelBtn.addEventListener('click', (e) => { e.stopPropagation(); cancelPendingMatch(m.id); });
                actionsDiv.appendChild(cancelBtn);
                item.appendChild(actionsDiv);
            } else if (m.status === 'active') {
                const actionsDiv = createElementSafe('div', { class: 'match-actions' });
                const reportBtn = createElementSafe('button', { class: 'btn btn-green' }, 'Report Result');
                reportBtn.addEventListener('click', (e) => { e.stopPropagation(); openReportResultModal(m.id); });
                actionsDiv.appendChild(reportBtn);
                item.appendChild(actionsDiv);
            } else if (m.status === 'disputed') {
                item.appendChild(createElementSafe('div', { class: 'match-actions' }, 'Disputed - awaiting admin'));
            } else if (m.status === 'completed') {
                const winnerText = m.winner_id === currentUser.id ? 'You won!' : (m.winner ? `${m.winner.username} won` : 'Completed');
                item.appendChild(createElementSafe('div', { class: 'match-detail' }, `üèÜ ${winnerText}`));
            }

            container.appendChild(item);
        });
    }

    async function cancelPendingMatch(matchId) {
        if (!confirm('Cancel this pending match? Your wager will be refunded.')) return;
        try {
            const res = await fetchWithAuth('/friends/cancel-match', {
                method: 'POST',
                body: JSON.stringify({ matchId })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            currentBalance += data.refundedAmount;
            updateBalanceDisplay();
            await loadMyFriendMatches();
        } catch (err) {
            alert(err.message);
        }
    }

    function openReportResultModal(matchId) {
        fetchWithAuth('/friends/my-matches').then(async res => {
            const matches = await res.json();
            const match = matches.find(m => m.id === matchId);
            if (!match) return alert('Match not found');
            currentReportMatch = match;
            const detailsDiv = document.getElementById('report-match-details');
            detailsDiv.innerHTML = `
                <div class="match-detail-row"><span class="match-detail-label">Wager</span><span class="match-detail-value">KES ${match.wager_amount}</span></div>
                <div class="match-detail-row"><span class="match-detail-label">Winner prize</span><span class="match-detail-value neon">KES ${match.winner_prize}</span></div>
            `;
            const select = document.getElementById('report-winner');
            select.innerHTML = `<option value="">-- Choose winner --</option>`;
            if (match.creator_id === currentUser.id || match.joiner_id === currentUser.id) {
                if (match.creator_id === currentUser.id) {
                    select.innerHTML += `<option value="${currentUser.id}">Me (${escapeHtml(currentUsername)})</option>`;
                    if (match.joiner_id) select.innerHTML += `<option value="${match.joiner_id}">Opponent (${escapeHtml(match.joiner?.username || 'Joiner')})</option>`;
                } else {
                    select.innerHTML += `<option value="${currentUser.id}">Me (${escapeHtml(currentUsername)})</option>`;
                    select.innerHTML += `<option value="${match.creator_id}">Opponent (${escapeHtml(match.creator?.username || 'Creator')})</option>`;
                }
            }
            document.getElementById('report-result-modal').classList.add('open');
        });
    }

    async function submitMatchResult() {
        if (!currentReportMatch) return;
        const winnerId = document.getElementById('report-winner').value;
        if (!winnerId) { showError('report-error', 'Please select a winner'); return; }
        const screenshot = document.getElementById('report-screenshot').value.trim();
        const btn = document.querySelector('#report-result-modal .btn-mpesa');
        btn.disabled = true;
        btn.textContent = 'Submitting...';
        try {
            const res = await fetchWithAuth('/friends/submit-result', {
                method: 'POST',
                body: JSON.stringify({
                    matchId: currentReportMatch.id,
                    winnerId,
                    screenshotUrl: screenshot || null
                })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error);
            alert(data.message);
            closeModal('report-result-modal');
            await loadMyFriendMatches();
        } catch (err) {
            showError('report-error', err.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'SUBMIT RESULT';
        }
    }

    // --- Room Code Share (for tournaments) ---
    function shareRoomCode() {
        const code = document.getElementById('room-code-display').innerText;
        const text = encodeURIComponent(`Join my match on Vumbua eFootball! Room code: ${code}. Play here: https://vumbua.app`);
        window.open(`https://wa.me/?text=${text}`, '_blank');
    }

    // --- Logout ---
    document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('supabaseToken');
        localStorage.removeItem('supabaseUser');
        window.location.href = '/login';
    });

    // --- Initial load ---
    window.onload = () => {
        if (!authToken) { window.location.href = '/login'; return; }
        loadDashboard();
    };
</script>
</body>
</html>