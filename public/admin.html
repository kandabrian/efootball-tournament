<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin | Vumbua eFootball</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://low-lilllie-kandabrian-18be1e15.koyeb.app;">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #060608; color: #f0f0f0; font-family: 'Outfit', sans-serif; min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .login-box { max-width: 400px; margin: 100px auto; background: #111116; border: 1px solid rgba(255,255,255,0.06); border-radius: 24px; padding: 40px; text-align: center; }
        .login-box h1 { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: #00ff41; letter-spacing: 2px; margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 14px; background: #1a1a20; border: 1px solid #2a2a30; border-radius: 12px; color: white; font-size: 1rem; margin-bottom: 20px; }
        .login-box button { width: 100%; padding: 14px; background: #00ff41; color: black; border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: transform 0.15s, box-shadow 0.15s; }
        .login-box button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(0,255,65,0.3); }
        .error { color: #ff4444; margin-top: 10px; display: none; }
        .dashboard { display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 20px; }
        .header h1 { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; color: #00ff41; letter-spacing: 2px; }
        .header button { background: #ff4444; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .tab { padding: 10px 20px; background: none; border: none; color: #888; font-weight: 600; cursor: pointer; font-size: 1rem; transition: color 0.2s; }
        .tab.active { color: #00ff41; border-bottom: 2px solid #00ff41; }
        .table-container { background: #111116; border: 1px solid #222; border-radius: 16px; overflow-x: auto; padding: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px 8px; color: #888; font-weight: 600; font-size: 0.85rem; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid #222; }
        td { padding: 16px 8px; border-bottom: 1px solid #1a1a20; }
        tr:last-child td { border-bottom: none; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .status-pending { background: rgba(255,180,0,0.1); color: #ffb400; border: 1px solid rgba(255,180,0,0.2); }
        .status-paid { background: rgba(0,255,65,0.1); color: #00ff41; border: 1px solid rgba(0,255,65,0.2); }
        .status-rejected { background: rgba(255,68,68,0.1); color: #ff4444; border: 1px solid rgba(255,68,68,0.2); }
        .status-open { background: rgba(0,255,65,0.1); color: #00ff41; border: 1px solid rgba(0,255,65,0.2); }
        .status-live { background: rgba(255,180,0,0.1); color: #ffb400; border: 1px solid rgba(255,180,0,0.2); }
        .status-closed { background: rgba(255,68,68,0.1); color: #ff4444; border: 1px solid rgba(255,68,68,0.2); }
        .status-disputed { background: rgba(255,68,68,0.2); color: #ff8888; border: 1px solid #ff4444; }
        .actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn { padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; border: none; cursor: pointer; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.8; }
        .btn-green { background: #00ff41; color: black; }
        .btn-red { background: #ff4444; color: white; }
        .btn-blue { background: #0088ff; color: white; }
        .btn-yellow { background: #ffb400; color: black; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.25s; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-content { background: #111116; border: 1px solid #222; border-radius: 24px; padding: 30px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-content h3 { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; margin-bottom: 20px; color: #00ff41; }
        .modal-content input, .modal-content select, .modal-content textarea { width: 100%; padding: 12px; background: #1a1a20; border: 1px solid #2a2a30; border-radius: 10px; color: white; margin-bottom: 20px; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-create { background: #00ff41; color: black; padding: 10px 20px; border-radius: 20px; font-weight: 600; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Admin Login -->
        <div id="login-section" class="login-box">
            <h1>VUMBUA ADMIN</h1>
            <input type="password" id="admin-key" placeholder="Enter Admin Key">
            <button onclick="login()">Access Dashboard</button>
            <div id="login-error" class="error">Invalid key</div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="header">
                <h1>Admin Dashboard</h1>
                <button onclick="logout()">Logout</button>
            </div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="withdrawals">Withdrawals</button>
                <button class="tab" data-tab="tournaments">Tournaments</button>
                <button class="tab" data-tab="friend-matches">Friend Matches</button>
            </div>

            <!-- Withdrawals Tab -->
            <div id="withdrawals-tab" class="tab-pane active">
                <div class="top-bar" style="margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;">
                    <div style="display:flex;gap:10px;align-items:center;">
                        <select id="wd-status-filter" style="background:#1a1a20;border:1px solid #2a2a30;color:#fff;padding:8px 14px;border-radius:10px;font-size:0.85rem;" onchange="loadWithdrawals()">
                            <option value="pending">Pending</option>
                            <option value="paid">Paid</option>
                            <option value="rejected">Rejected</option>
                        </select>
                        <button onclick="loadWithdrawals()" class="btn btn-blue" style="padding:8px 16px;">&#8635; Refresh</button>
                    </div>
                    <div id="wd-summary" style="font-size:0.85rem;color:#888;"></div>
                </div>
                <div id="withdrawal-cards" style="display:grid;gap:14px;"></div>
                <table id="withdrawals-table" style="display:none"><thead><tr><th>ID</th><th>User</th><th>Amount</th><th>Phone</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>

            <!-- Tournaments Tab -->
            <div id="tournaments-tab" class="tab-pane" style="display: none;">
                <div class="top-bar">
                    <h2>Tournaments</h2>
                    <button class="btn-create" onclick="openTournamentModal()">+ Create Tournament</button>
                </div>
                <div class="table-container">
                    <table id="tournaments-table">
                        <thead>
                            <tr><th>Name</th><th>Entry Fee</th><th>Start Time</th><th>Max Players</th><th>Room Code</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- Friend Matches Tab -->
            <div id="friend-matches-tab" class="tab-pane" style="display: none;">
                <div class="top-bar">
                    <h2>Friend Matches</h2>
                    <select id="fm-status-filter" style="background:#1a1a20; color:white; border:1px solid #2a2a30; border-radius:8px; padding:6px 12px;">
                        <option value="all">All</option>
                        <option value="pending">Pending</option>
                        <option value="active">Active</option>
                        <option value="disputed">Disputed</option>
                        <option value="completed">Completed</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
                <div class="table-container">
                    <table id="friend-matches-table">
                        <thead>
                            <tr><th>Code</th><th>Creator</th><th>Joiner</th><th>Wager</th><th>Winner Prize</th><th>Status</th><th>Actions</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tournament Modal -->
    <div id="tournament-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('tournament-modal')">
        <div class="modal-content">
            <h3 id="tournament-modal-title">Create Tournament</h3>
            <input type="text" id="tournament-name" placeholder="Tournament Name">
            <input type="number" id="tournament-fee" placeholder="Entry Fee (KES)">
            <input type="datetime-local" id="tournament-start" placeholder="Start Time">
            <input type="number" id="tournament-max" placeholder="Max Players">
            <input type="text" id="tournament-room" placeholder="Room Code (optional)">
            <select id="tournament-status">
                <option value="open">Open</option>
                <option value="live">Live</option>
                <option value="closed">Closed</option>
            </select>
            <div class="modal-actions">
                <button class="btn btn-green" id="tournament-save" onclick="saveTournament()">Save</button>
                <button class="btn btn-red" onclick="closeModal('tournament-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Delete Tournament Modal -->
    <div id="delete-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('delete-modal')">
        <div class="modal-content">
            <h3>Confirm Delete</h3>
            <p>Are you sure you want to delete this tournament?</p>
            <div class="modal-actions">
                <button class="btn btn-red" onclick="confirmDelete()">Delete</button>
                <button class="btn" onclick="closeModal('delete-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Dispute Resolution Modal -->
    <div id="dispute-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('dispute-modal')">
        <div class="modal-content">
            <h3>Resolve Dispute</h3>
            <p>Select the winner for this match.</p>
            <select id="dispute-winner">
                <option value="">-- Choose winner --</option>
            </select>
            <div class="modal-actions">
                <button class="btn btn-green" onclick="resolveDispute()">Confirm Winner</button>
                <button class="btn btn-red" onclick="closeModal('dispute-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Paid / Reject Modals -->
    <div id="paid-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('paid-modal')">
        <div class="modal-content">
            <h3>Mark as Paid</h3>
            <input type="text" id="mpesa-code" placeholder="M-PESA Transaction Code">
            <div class="modal-actions">
                <button class="btn btn-green" onclick="submitPaid()">Confirm</button>
                <button class="btn btn-red" onclick="closeModal('paid-modal')">Cancel</button>
            </div>
        </div>
    </div>
    <div id="reject-modal" class="modal-overlay" onclick="if(event.target === this) closeModal('reject-modal')">
        <div class="modal-content">
            <h3>Reject Withdrawal</h3>
            <textarea id="reject-reason" placeholder="Reason for rejection (optional)" rows="3"></textarea>
            <div class="modal-actions">
                <button class="btn btn-red" onclick="submitReject()">Reject</button>
                <button class="btn" onclick="closeModal('reject-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- Escape function for XSS prevention ---
        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // --- Helper to safely create elements with text content ---
        function createElementSafe(tag, attributes = {}, textContent = '') {
            const el = document.createElement(tag);
            Object.entries(attributes).forEach(([key, value]) => el.setAttribute(key, value));
            if (textContent) el.textContent = escapeHtml(textContent);
            return el;
        }

        // --- State ---
        let adminKey = localStorage.getItem('adminKey');
        let currentWithdrawalId = null;
        let currentTournamentId = null;
        let currentFriendMatchId = null;

        // Check login
        if (adminKey) {
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            loadWithdrawals();
        }

        // --- Tab switching ---
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.querySelectorAll('.tab-pane').forEach(pane => pane.style.display = 'none');
                document.getElementById(tabName + '-tab').style.display = 'block';
                if (tabName === 'withdrawals') loadWithdrawals();
                else if (tabName === 'tournaments') loadTournaments();
                else loadFriendMatches();
            });
        });

        // --- Login ---
        function login() {
            const key = document.getElementById('admin-key').value;
            if (!key) return;
            adminKey = key;
            localStorage.setItem('adminKey', key);
            // Test the key by fetching withdrawals
            fetchWithdrawals('pending').then(data => {
                if (data.error) throw new Error(data.error);
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                loadWithdrawals();
            }).catch(() => {
                document.getElementById('login-error').style.display = 'block';
                localStorage.removeItem('adminKey');
                adminKey = null;
            });
        }

        function logout() {
            localStorage.removeItem('adminKey');
            adminKey = null;
            document.getElementById('login-section').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
        }

        // Auto-detect: Use localhost for local dev, Koyeb URL for production
        const isLocal = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API = isLocal 
            ? 'http://localhost:3000' 
            : 'https://low-lilllie-kandabrian-18be1e15.koyeb.app';
        console.log('üîç Environment:', isLocal ? 'LOCAL' : 'PRODUCTION');
        console.log('üîç API URL:', API);

        async function adminFetch(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'x-admin-key': adminKey,
                ...options.headers
            };
            const fullUrl = url.startsWith('http') ? url : `${API}${url}`;
            const res = await fetch(fullUrl, { ...options, headers });
            if (res.status === 403) {
                alert('Session expired');
                logout();
                return null;
            }
            return res;
        }

        // ========== WITHDRAWALS ==========
        async function fetchWithdrawals(status = 'pending') {
            const res = await adminFetch(`/admin/withdrawals?status=${status}`);
            return res ? await res.json() : [];
        }

        async function loadWithdrawals() {
            const status = document.getElementById('wd-status-filter')?.value || 'pending';
            const data = await fetchWithdrawals(status);
            if (data) renderWithdrawals(data, status);
        }

        function renderWithdrawals(withdrawals, status = 'pending') {
            const container = document.getElementById('withdrawal-cards');
            container.innerHTML = '';
            if (!withdrawals || withdrawals.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:40px;color:#555;background:#111116;border:1px solid #1a1a20;border-radius:16px;"><div style="font-size:2rem;margin-bottom:8px;">üì≠</div><div>No ' + status + ' withdrawals</div></div>';
                document.getElementById('wd-summary').textContent = '';
                return;
            }
            const total = withdrawals.reduce((s, w) => s + parseFloat(w.amount), 0);
            document.getElementById('wd-summary').textContent = withdrawals.length + ' request' + (withdrawals.length !== 1 ? 's' : '') + ' ¬∑ Total: KES ' + total.toLocaleString();
            withdrawals.forEach(w => {
                const card = document.createElement('div');
                card.style.cssText = 'background:#111116;border:1px solid #1e1e24;border-radius:16px;padding:20px;display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;';
                const info = document.createElement('div');
                const topRow = document.createElement('div');
                topRow.style.cssText = 'display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-wrap:wrap;';
                const nameEl = document.createElement('span');
                nameEl.style.cssText = 'font-family:"Bebas Neue",sans-serif;font-size:1.4rem;letter-spacing:2px;color:#f0f0f0;';
                nameEl.textContent = w.name || 'Unknown';
                const amountEl = document.createElement('span');
                amountEl.style.cssText = 'font-family:"Bebas Neue",sans-serif;font-size:1.6rem;color:#00ff41;letter-spacing:1px;';
                amountEl.textContent = 'KES ' + parseFloat(w.amount).toLocaleString();
                topRow.appendChild(nameEl);
                topRow.appendChild(amountEl);
                info.appendChild(topRow);
                const phoneRow = document.createElement('div');
                phoneRow.style.cssText = 'display:flex;align-items:center;gap:16px;flex-wrap:wrap;';
                const phoneCopy = document.createElement('span');
                phoneCopy.style.cssText = 'font-size:1.1rem;font-weight:700;color:#fff;background:#1a1a20;padding:6px 14px;border-radius:8px;letter-spacing:1px;cursor:pointer;';
                phoneCopy.textContent = w.phone;
                phoneCopy.title = 'Click to copy';
                phoneCopy.addEventListener('click', () => {
                    navigator.clipboard.writeText(w.phone);
                    phoneCopy.style.background = 'rgba(0,255,65,0.2)';
                    setTimeout(() => phoneCopy.style.background = '#1a1a20', 1000);
                });
                phoneRow.appendChild(phoneCopy);
                const timeEl = document.createElement('span');
                timeEl.style.cssText = 'font-size:0.75rem;color:#555;';
                timeEl.textContent = new Date(w.created_at).toLocaleString('en-KE');
                phoneRow.appendChild(timeEl);
                info.appendChild(phoneRow);
                card.appendChild(info);
                const actions = document.createElement('div');
                actions.style.cssText = 'display:flex;flex-direction:column;gap:8px;align-items:flex-end;';
                if (status === 'pending') {
                    const waBtn = document.createElement('a');
                    const msg = encodeURIComponent('Vumbua withdrawal: KES ' + w.amount + ' to ' + w.phone + ' for ' + w.name);
                    waBtn.href = 'https://wa.me/?text=' + msg;
                    waBtn.target = '_blank';
                    waBtn.style.cssText = 'background:#25d366;color:#000;padding:8px 16px;border-radius:10px;font-weight:700;font-size:0.8rem;text-decoration:none;text-align:center;';
                    waBtn.textContent = 'üì≤ WhatsApp Note';
                    actions.appendChild(waBtn);
                    const paidBtn = document.createElement('button');
                    paidBtn.className = 'btn btn-green';
                    paidBtn.style.cssText = 'padding:8px 20px;font-size:0.85rem;';
                    paidBtn.textContent = '‚úÖ Mark Paid';
                    paidBtn.addEventListener('click', () => openPaidModal(w.id));
                    actions.appendChild(paidBtn);
                    const rejectBtn = document.createElement('button');
                    rejectBtn.className = 'btn btn-red';
                    rejectBtn.style.cssText = 'padding:8px 20px;font-size:0.85rem;';
                    rejectBtn.textContent = '‚úó Reject';
                    rejectBtn.addEventListener('click', () => openRejectModal(w.id));
                    actions.appendChild(rejectBtn);
                } else {
                    const statusBadge = document.createElement('span');
                    statusBadge.className = 'status-badge status-' + status;
                    statusBadge.textContent = status;
                    actions.appendChild(statusBadge);
                    if (w.mpesa_code) {
                        const codeEl = document.createElement('div');
                        codeEl.style.cssText = 'font-size:0.75rem;color:#555;';
                        codeEl.textContent = 'Code: ' + w.mpesa_code;
                        actions.appendChild(codeEl);
                    }
                }
                card.appendChild(actions);
                container.appendChild(card);
            });
        }

        function openPaidModal(id) { currentWithdrawalId = id; document.getElementById('mpesa-code').value = ''; document.getElementById('paid-modal').classList.add('open'); }
        async function submitPaid() {
            const mpesaCode = document.getElementById('mpesa-code').value.trim();
            if (!mpesaCode) return alert('Enter M-PESA code');
            const res = await adminFetch(`/admin/withdrawals/${currentWithdrawalId}/paid`, { method: 'PATCH', body: JSON.stringify({ mpesaCode }) });
            if (res && res.ok) { closeModal('paid-modal'); loadWithdrawals(); } else alert('Failed');
        }
        function openRejectModal(id) { currentWithdrawalId = id; document.getElementById('reject-reason').value = ''; document.getElementById('reject-modal').classList.add('open'); }
        async function submitReject() {
            const reason = document.getElementById('reject-reason').value.trim();
            const res = await adminFetch(`/admin/withdrawals/${currentWithdrawalId}/reject`, { method: 'PATCH', body: JSON.stringify({ reason }) });
            if (res && res.ok) { closeModal('reject-modal'); loadWithdrawals(); } else alert('Failed');
        }

        // ========== TOURNAMENTS ==========
        async function loadTournaments() {
            const res = await adminFetch('/admin/tournaments');
            if (!res) return;
            const data = await res.json();
            renderTournaments(data);
        }

        function renderTournaments(tournaments) {
            const tbody = document.querySelector('#tournaments-table tbody');
            tbody.innerHTML = '';
            if (!tournaments || tournaments.length === 0) {
                const row = document.createElement('tr');
                const td = createElementSafe('td', { colspan: '7', style: 'text-align:center; color:#888;' }, 'No tournaments');
                row.appendChild(td);
                tbody.appendChild(row);
                return;
            }
            tournaments.forEach(t => {
                const row = document.createElement('tr');
                row.appendChild(createElementSafe('td', {}, t.name));
                row.appendChild(createElementSafe('td', {}, `KES ${t.entry_fee}`));
                const start = new Date(t.start_time).toLocaleString();
                row.appendChild(createElementSafe('td', {}, start));
                row.appendChild(createElementSafe('td', {}, t.max_players));
                row.appendChild(createElementSafe('td', {}, t.room_code || '‚Äî'));
                const statusTd = document.createElement('td');
                const statusClass = t.status === 'open' ? 'status-open' : t.status === 'live' ? 'status-live' : 'status-closed';
                const badge = createElementSafe('span', { class: `status-badge ${statusClass}` }, t.status);
                statusTd.appendChild(badge);
                row.appendChild(statusTd);
                const actionsTd = document.createElement('td');
                actionsTd.className = 'actions';
                const editBtn = createElementSafe('button', { class: 'btn btn-yellow' }, 'Edit');
                editBtn.addEventListener('click', () => editTournament(t.id));
                actionsTd.appendChild(editBtn);
                const deleteBtn = createElementSafe('button', { class: 'btn btn-red' }, 'Delete');
                deleteBtn.addEventListener('click', () => openDeleteModal(t.id));
                actionsTd.appendChild(deleteBtn);
                row.appendChild(actionsTd);
                tbody.appendChild(row);
            });
        }

        function openTournamentModal() {
            currentTournamentId = null;
            document.getElementById('tournament-modal-title').innerText = 'Create Tournament';
            document.getElementById('tournament-name').value = '';
            document.getElementById('tournament-fee').value = '';
            document.getElementById('tournament-start').value = '';
            document.getElementById('tournament-max').value = '';
            document.getElementById('tournament-room').value = '';
            document.getElementById('tournament-status').value = 'open';
            document.getElementById('tournament-modal').classList.add('open');
        }

        async function editTournament(id) {
            currentTournamentId = id;
            const res = await adminFetch(`/admin/tournaments/${id}`);
            if (!res) return;
            const t = await res.json();
            document.getElementById('tournament-modal-title').innerText = 'Edit Tournament';
            document.getElementById('tournament-name').value = t.name;
            document.getElementById('tournament-fee').value = t.entry_fee;
            const start = new Date(t.start_time);
            const year = start.getFullYear();
            const month = String(start.getMonth() + 1).padStart(2, '0');
            const day = String(start.getDate()).padStart(2, '0');
            const hours = String(start.getHours()).padStart(2, '0');
            const mins = String(start.getMinutes()).padStart(2, '0');
            document.getElementById('tournament-start').value = `${year}-${month}-${day}T${hours}:${mins}`;
            document.getElementById('tournament-max').value = t.max_players;
            document.getElementById('tournament-room').value = t.room_code || '';
            document.getElementById('tournament-status').value = t.status;
            document.getElementById('tournament-modal').classList.add('open');
        }

        async function saveTournament() {
            const name = document.getElementById('tournament-name').value.trim();
            const fee = parseFloat(document.getElementById('tournament-fee').value);
            const start = document.getElementById('tournament-start').value;
            const max = parseInt(document.getElementById('tournament-max').value);
            const room = document.getElementById('tournament-room').value.trim();
            const status = document.getElementById('tournament-status').value;

            if (!name || !fee || !start || !max) return alert('Please fill all required fields');

            const payload = {
                name,
                entry_fee: fee,
                start_time: new Date(start).toISOString(),
                max_players: max,
                room_code: room || null,
                status
            };

            let res;
            if (currentTournamentId) {
                res = await adminFetch(`/admin/tournaments/${currentTournamentId}`, {
                    method: 'PATCH',
                    body: JSON.stringify(payload)
                });
            } else {
                res = await adminFetch('/admin/tournaments', {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
            }

            if (res && res.ok) {
                closeModal('tournament-modal');
                loadTournaments();
            } else {
                alert('Save failed');
            }
        }

        function openDeleteModal(id) {
            currentTournamentId = id;
            document.getElementById('delete-modal').classList.add('open');
        }

        async function confirmDelete() {
            const res = await adminFetch(`/admin/tournaments/${currentTournamentId}`, { method: 'DELETE' });
            if (res && res.ok) {
                closeModal('delete-modal');
                loadTournaments();
            } else {
                alert('Delete failed');
            }
        }

        // ========== FRIEND MATCHES ==========
        async function loadFriendMatches() {
            const status = document.getElementById('fm-status-filter').value;
            const url = status === 'all' ? '/admin/friend-matches' : `/admin/friend-matches?status=${status}`;
            const res = await adminFetch(url);
            if (!res) return;
            const data = await res.json();
            renderFriendMatches(data);
        }

        function renderFriendMatches(matches) {
            const tbody = document.querySelector('#friend-matches-table tbody');
            tbody.innerHTML = '';
            if (!matches || matches.length === 0) {
                const row = document.createElement('tr');
                const td = createElementSafe('td', { colspan: '7', style: 'text-align:center; color:#888;' }, 'No friend matches');
                row.appendChild(td);
                tbody.appendChild(row);
                return;
            }
            matches.forEach(m => {
                const row = document.createElement('tr');
                row.appendChild(createElementSafe('td', {}, m.match_code));
                const creatorName = m.creator?.username || m.creator_id.substring(0,8);
                row.appendChild(createElementSafe('td', {}, creatorName));
                const joinerName = m.joiner ? (m.joiner.username || m.joiner_id.substring(0,8)) : '‚Äî';
                row.appendChild(createElementSafe('td', {}, joinerName));
                row.appendChild(createElementSafe('td', {}, `KES ${m.wager_amount}`));
                row.appendChild(createElementSafe('td', {}, `KES ${m.winner_prize}`));
                const statusTd = document.createElement('td');
                const statusClass = 
                    m.status === 'pending' ? 'status-pending' :
                    m.status === 'active' ? 'status-live' :
                    m.status === 'disputed' ? 'status-disputed' : 'status-closed';
                const badge = createElementSafe('span', { class: `status-badge ${statusClass}` }, m.status);
                statusTd.appendChild(badge);
                row.appendChild(statusTd);
                const actionsTd = document.createElement('td');
                actionsTd.className = 'actions';
                if (m.status === 'disputed') {
                    const resolveBtn = createElementSafe('button', { class: 'btn btn-yellow' }, 'Resolve');
                    resolveBtn.addEventListener('click', () => openDisputeModal(m.id, m.creator_id, m.joiner_id));
                    actionsTd.appendChild(resolveBtn);
                } else {
                    actionsTd.appendChild(createElementSafe('span', {}, '‚Äî'));
                }
                row.appendChild(actionsTd);
                tbody.appendChild(row);
            });
        }

        function openDisputeModal(matchId, creatorId, joinerId) {
            currentFriendMatchId = matchId;
            const select = document.getElementById('dispute-winner');
            select.innerHTML = `<option value="">-- Choose winner --</option>
                <option value="${escapeHtml(creatorId)}">Creator (${escapeHtml(creatorId.substring(0,8))})</option>
                <option value="${escapeHtml(joinerId)}">Joiner (${escapeHtml(joinerId.substring(0,8))})</option>`;
            document.getElementById('dispute-modal').classList.add('open');
        }

        async function resolveDispute() {
            const winnerId = document.getElementById('dispute-winner').value;
            if (!winnerId) return alert('Select a winner');
            const res = await adminFetch(`/admin/resolve-dispute/${currentFriendMatchId}`, {
                method: 'POST',
                body: JSON.stringify({ winnerId })
            });
            if (res && res.ok) {
                closeModal('dispute-modal');
                loadFriendMatches();
            } else {
                alert('Failed to resolve dispute');
            }
        }

        // ========== UI Helpers ==========
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('open');
            if (modalId === 'paid-modal' || modalId === 'reject-modal') currentWithdrawalId = null;
            if (modalId === 'tournament-modal') currentTournamentId = null;
            if (modalId === 'dispute-modal') currentFriendMatchId = null;
        }

        // Attach filter change listener
        document.getElementById('fm-status-filter').addEventListener('change', loadFriendMatches);
    </script>
</body>
</html>